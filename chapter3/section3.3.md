##外围设备和总线

连接到你计算机的许多外部设备中的任何一个都称为外围设备。显然，处理器必须有某种方式与外围设备对话，以使它们有用。

处理器和外围设备之间的通信通道称为_总线_。

##外围总线概念

为了让其有用，设备需要输入和输出。要与外围设备进行有用的通信，需要有许多共同的概念。

###中断

中断允许设备中断处理器以标记某些信息。例如，当一个键被按下时，会产生一个中断来将按键事件传递给操作系统。每个设备都由操作系统和BIOS的某种组合分配一个中断。

设备通常连接到一个_可编程中断控制器_(PIC)，这是一个独立的芯片，它是主板的一部分，它缓冲和通信中断信息给主处理器。每个设备与系统提供的PIC之间都有一个物理_中断线_。当设备要中断时，它将修改这条线路上的电压。

PIC作用的一个非常广泛的描述是，它接收这个中断并将其转换为一条消息供主处理器使用。虽然确切的过程因体系结构而异，但一般原则是操作系统配置了一个_中断描述符表_（IDT），该表将每个可能的中断与一个代码地址配对，以便在接收到中断时跳转。如[图3.6](#interrupt)所示

编写此_中断处理程序_是设备驱动程序作者与操作系统一起完成的工作。

图3.6 中断处理概述

<span id="interrupt">

![](https://www.bottomupcs.com/chapter02/figures/interrupt.png)

处理中断的一般概述。设备将中断引发到中断控制器，中断控制器将信息传递给处理器。处理器查看由操作系统填充的描述符表，以找到处理故障的代码。




大多数驱动程序会将中断处理分为_底层_和_上层_两部分。底层部分将确认中断，对处理的操作进行排队，并将处理器快速返回到它正在执行的操作。上层部分将在CPU空闲后运行并进行更密集的处理。这是为了防止中断占用整个CPU。

####保存状态

由于中断可以在任何时候发生，所以在完成中断处理后可以返回到正在运行的操作，这一点很重要。通常，操作系统的任务是确保在进入中断处理程序时，保存所有_状态_；即：寄存器，并在从中断处理程序返回时恢复它们。通过这种方式，除了一些丢失的时间之外，中断对于当时正在运行的任何事情都是完全透明的。

####中断 v 陷阱和异常

虽然中断通常与来自物理设备的外部事件相关联，但同样的机制对于处理内部系统操作非常有用。例如，如果处理器检测到诸如对无效内存的访问、试图将其除以零或无效指令等条件，它可以在内部引发一个由操作系统处理的_异常_。正如在[第6章“虚拟内存”](/chapter6/section6.1.html)中讨论的那样，它也是用于陷入系统调用的操作系统的机制，如[“系统调用”](/chapter4/section4.3.html)一节中讨论的那样，并实现虚拟内存。虽然内部生成而不是从外部源生成，但异步中断运行代码的原则仍然相同。

###中断类型

在线路上有两种主要的信号中断方式-_电平_和_边缘_触发。

电平触发中断定义中断线路的电压保持在高位，以指示中断正在挂起。边缘触发的中断检测总线上的过渡；即线路电压从低到高。在边缘触发中断的情况下，PIC检测到方波脉冲作为信号并引起中断。

当设备共享中断行时，这种差异会体现出来。在一个电平触发的系统中，中断线将很高，直到所有已经引发中断的设备都被处理并且没有断言它们的中断。

在边缘触发系统中，线路上的脉冲将向PIC指示发生中断，并将中断信号发送给操作系统进行处理。然而，如果进一步的脉冲来自另一个设备已经断言的线路。

电平触发中断的问题是，可能需要相当长的时间来处理设备的中断。在此期间，中断线保持较高，无法确定是否有任何其他设备在该线路上引发中断。这意味着在服务中断时可能会有相当大的不可预测的延迟。

使用边缘触发的中断，可以注意到并排队等待一个长时间运行的中断，但在这种情况发生时，其他共享线路的设备仍然可以转换(从而引发中断)。然而，这带来了新的问题；如果两个设备同时中断，可能会错过其中一个中断，环境或其他干扰可能会造成一个应该忽略的_假性_中断。

###不可掩蔽中断

对于系统来说，能够在某些时候屏蔽或防止中断是很重要的。通常，中断是可以暂停的，但是有一种特殊类型的中断，称为_不可屏蔽中断_(NMI)，是这条规则的例外。典型的例子是_复位_中断。

NMI对于实现诸如系统监视狗之类的东西很有用，在这种情况下，NMI会周期性地被引发，并设置一些必须由操作系统确认的标志。如果在下一个周期的NMI没有看到之前的确认，则可以认为系统没有进展。另一个常见用途是分析系统。可以提出周期性NMI并用于评估处理器当前正在运行的代码;随着时间的推移，这会构建一个正在运行的代码的概要文件，并为系统性能创建非常有用的洞察。

###IO空间

显然，处理器将需要与外围设备通信，并通过IO操作来实现这一点。最常见的IO形式称为_Memory映射IO_其中设备上的寄存器被映射到内存中。

这意味着要与设备通信，只需将其读写到内存中的特定地址。Todo：扩展

###DMA

由于设备的速度远远低于处理器的速度，因此需要有一些方法来避免CPU等待设备的数据。

直接存储器存取(DMA)是一种直接在外围设备和系统RAM之间传输数据的方法。

驱动程序可以通过告知设备存放数据的RAM区域来设置一个设备用以完成DMA传输。然后，它可以启动DMA传输，并允许CPU继续执行其他任务。

一旦设备完成，它将引发中断并向驱动程序发出信号，传输完成。从这个时候起，来自设备的数据(例如来自磁盘的文件，或者来自视频采集卡的帧)在内存中并准备使用。

##其他总线

其它总线连接在PCI总线和外部设备之间。

###USB

从操作系统的角度来看，USB设备是一组集合在一起的终端点，组成一个接口。一个可以是_输入_也可以是_输出_的端点，因此只能向一个方向传输数据。端点可以有许多不同的类型：

* _控制_端点用于配置设备等。

* _中断_端点用于传输少量数据。它们的优先级高于...

* _批量_端点传输大量数据，但不能保证时间限制

* _等时_传输是高优先级的实时传输，但如果错过，则不会重新尝试。这是用于流数据，如视频或音频，再次发送数据没有意义。





可以有许多接口（由多个端点组成），接口被分组为_配置_。但是大多数设备只有一个配置。

图3.7 UHCI控制器操作概述

<span id="UHCI">

![](https://www.bottomupcs.com/chapter02/images/uhci.png)

UHCI控制器操作概述,取自[Intel documentation](http://download.intel.com/technology/usb/UHCI11D.pdf).




[图3.7，“UHCI控制器操作概述”](#UHCI)显示了通用主机控制器接口(UHCI)的概述。它提供了USB数据如何通过硬件和软件相结合的方式从系统中移出的概述。从本质上讲，该软件为主机控制器设置了一个特定格式的数据模板，以便通过USB总线读取和发送数据。

从概览的左上角开始，控制器具有一个_Frame_寄存器和一个计数器，该计数器周期性地递增--每毫秒。此值用于对软件创建的_FrameList_进行索引。该表中的每个条目指向一个_Transfer描述符_队列。软件在内存中设置这些数据，由主机控制器读取，主机控制器是驱动USB总线的独立芯片。软件需要对工作队列进行调度，以便将帧时间的90%分配给等时数据，并为中断、控制和大容量数据留出10%。

从图表中可以看到，数据链接的方式意味着，等时数据的传输描述符只与一个特定的帧指针相关联--换句话说，只有一个特定的时间段--之后将被丢弃。但是，中断、控制和大容量数据都是排在等时数据之后的，因此，如果没有在一个帧(时间段)中传输完成，则将在下一个帧(时间段)中完成。

USB层通过USB_请求_块或URBs进行通信。URB包含关于此请求与哪个端点相关的信息、数据、任何相关信息或属性以及当URB完成时要调用的回调函数。USB驱动程序将固定格式的URB提交给USB核心，USB核心与USB主机控制器协调管理它们。您的数据通过USB核心被发送到USB设备，当它完成时您的回调被触发。
